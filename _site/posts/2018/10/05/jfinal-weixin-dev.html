<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta http-equiv="content-language" content="zh-CN" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
		<meta name="keywords" content="TMaize,java"/>
		<meta name="author" content="TMaize" />
		<meta name="description" content="jfinal-weixin 极速开发"/>
		<link rel="icon" href="/static/img/favicon.ico" type="image/x-icon" />
		<link rel="shortcut icon" href="/static/img/favicon.ico" type="image/x-icon"/>
		<link rel="stylesheet" href="/static/css/blog.css">
		<link rel="stylesheet" href="/static/css/blog-post.css">
		<script>window.blog={contextPath:""}</script>
		<script type="text/javascript" src="/static/js/blog.js"></script>
		<title>jfinal-weixin 极速开发-TMaize Blog</title>
	</head>
<body>
<header class="header select-none">
    <a class="logo" title="TMaize Blog" href="/">
        <img src="/static/img/logo.jpg">
    </a>
    <a class="title" href="/">TMaize Blog</a>
    <nav class="menu">
        <a href="/">Blog</a>
        <a href="/pages/categories.html">Categories</a>
        <a href="/pages/search.html">Search</a>
        <a href="/pages/links.html">Links</a>
        <a href="/pages/chat.html">Chat</a>
        <a href="/pages/about.html">About</a>
    </nav>
    <span class="icon"></span>
</header>
	<div class="main animation-fadeUp post">
		
		<h1 class="title">jfinal-weixin 极速开发</h1>
		
		<div class="content"><p>使用最原始的方式做公众号开发是效率很低的。http 请求，报文解析转换，access_token 的维护等都要自已写一遍</p>

<p>好在有 jfinal-weixin 的存在，大大的简化了开发，jfinal-weixin 是 jfinal 的一个插件，不过貌似也可以集成的其他的框架里</p>

<p>jfinal 就不说了，很好用的一个框架，下面主要是 jfinal-weixin 的使用</p>

<p>项目最小依赖</p>

<ul>
  <li>
    <p>fastjson-1.2.31.jar</p>
  </li>
  <li>
    <p>jfinal-3.4-bin-with-src</p>
  </li>
  <li>
    <p>jfinal-weixin-2.1.jar</p>
  </li>
</ul>

<h2 id="appconfig">AppConfig</h2>

<p>web.xml 的配置,指定 AppConfig 的位置</p>

<p>```
<?xml version="1.0" encoding="UTF-8"?></p>
<web-app xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://xmlns.jcp.org/xml/ns/javaee" xsi:schemalocation="http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd" id="WebApp_ID" version="3.1">
    <display-name>wx</display-name>
    <welcome-file-list>
        <welcome-file>index.html</welcome-file>
        <welcome-file>index.jsp</welcome-file>
    </welcome-file-list>
    <filter>
        <filter-name>jfinal</filter-name>
        <filter-class>com.jfinal.core.JFinalFilter</filter-class>
        <init-param>
            <param-name>configClass</param-name>
            <param-value>net.tmaize.wx.AppConfig</param-value>
        </init-param>
    </filter>
    <filter-mapping>
        <filter-name>jfinal</filter-name>
        <url-pattern>/*</url-pattern>
    </filter-mapping>
</web-app>
<p>```</p>

<p>config.txt</p>

<p>```
token = <strong>**</strong><strong>**
appId = **</strong><strong>**</strong>
appSecret = <strong>**</strong><em>**</em></p>

<h1 id="section">开发</h1>
<p>onlineWebRoot = /usr/local/tomcat-7.0.90/webapps/wx
onlineTokenUrl = http://wx.tmaize.net/api/wx/api/getToken
```</p>

<p>AppConfig.java</p>

<p>```
public class AppConfig extends JFinalConfig {</p>

<div class="highlighter-rouge"><pre class="highlight"><code>@Override
public void configConstant(Constants me) {
    PropKit.use("config.txt");
    me.setViewType(ViewType.JFINAL_TEMPLATE);
    boolean isOnline = isOnlineEnv();
    // 打印请求信息
    me.setDevMode(isOnline);
    // 打印微信API请求交互的 xml与json数据
    ApiConfigKit.setDevMode(isOnline);
}

@Override
public void configRoute(Routes me) {
    me.add("/", IndexController.class);
    // 微信收发消息及服务器验证地址
    me.add("/api/wx/msg", WeixinMsgController.class);
    me.add("/api/wx/api", WeixinApiController.class);
}

@Override
public void afterJFinalStart() {
    super.afterJFinalStart();

    ApiConfig ac = new ApiConfig();
    // 配置微信 API 相关参数
    ac.setToken(PropKit.get("token"));
    ac.setAppId(PropKit.get("appId"));
    ac.setAppSecret(PropKit.get("appSecret"));
    // 明文模式，密文要setEncodingAesKey
    ac.setEncryptMessage(PropKit.getBoolean("encryptMessage", false));
    // 多个公众号时，重复调用ApiConfigKit.putApiConfig(ac)依次添加即可，第一个添加的是默认
    ApiConfigKit.putApiConfig(ac);

    // 开发时使用线上AccessToken
    if (!isOnlineEnv()) {
        LocalTestTokenCache localTestTokenCache = new LocalTestTokenCache(PropKit.get("onlineTokenUrl"));
        ApiConfigKit.setAccessTokenCache(localTestTokenCache);
    }
}

/**
 * 环境判断
 * @return
 */
public boolean isOnlineEnv() {
    return PropKit.get("onlineWebRoot").equals(PathKit.getWebRootPath());
} } ```
</code></pre>
</div>

<h2 id="accesstoken">获取 access_token</h2>

<p>获取 access_token 就是调用一个接口那简单，上面配置了一个 URL 供开发环境获取线上的 access_token，看下里面是怎么获取的就知道了</p>

<p>WeixinApiController.java</p>

<p>```
package net.tmaize.wx.controller;</p>

<p>import com.jfinal.weixin.sdk.api.AccessToken;
import com.jfinal.weixin.sdk.api.AccessTokenApi;
import com.jfinal.weixin.sdk.jfinal.ApiController;</p>

<p>public class WeixinApiController extends ApiController {</p>

<div class="highlighter-rouge"><pre class="highlight"><code>/**
 * 为开发环境提供AccessToken
 */
public void getToken() {
    // 一行代码搞定
    AccessToken accessToken = AccessTokenApi.getAccessToken();
    renderJson(accessToken.getJson());
} } ```
</code></pre>
</div>

<h2 id="section-1">服务器验证及收发消息</h2>

<p>只需要继承 MsgControllerAdapter 就行了，该地址就具备了服务器验证的能力和收发信息的能力</p>

<p>当然了发信息的逻辑要自己实现</p>

<p><code class="highlighter-rouge">
/**
 * 处理接收到的文本消息
 * @param inTextMsg 处理接收到的文本消息
 */
@Override
protected void processInTextMsg(InTextMsg inTextMsg) {
    OutTextMsg outMsg = new OutTextMsg(inTextMsg);
    switch (inTextMsg.getContent()) {
    case "个人信息":
        // 未认证订阅号，没有这个权限
        ApiResult userInfo = UserApi.getUserInfo(inTextMsg.getFromUserName());
        outMsg.setContent(userInfo.getJson());
        break;
    case "token":
        outMsg.setContent(AccessTokenApi.getAccessTokenStr());
        break;
    default:
        outMsg.setContent(inTextMsg.getContent());
        break;
    }
    render(outMsg);
}
</code></p>

<h2 id="section-2">调试</h2>

<p>有时候需要本地调用微信接口来调试，但是又不想启动整个 web 项目，也是有办法的</p>

<p>```
/**
 * 测试微信API
 * @author tmaize
 *
 */
public class WXTest {
    public static void init() {
        PropKit.use(“config.txt”);
        ApiConfig ac = new ApiConfig();
        ac.setToken(PropKit.get(“token”));
        ac.setAppId(PropKit.get(“appId”));
        ac.setAppSecret(PropKit.get(“appSecret”));
        ac.setEncryptMessage(PropKit.getBoolean(“encryptMessage”, false));
        ApiConfigKit.putApiConfig(ac);
        if (!PropKit.get(“onlineWebRoot”).equals(PathKit.getWebRootPath())) {
            LocalTestTokenCache localTestTokenCache = new LocalTestTokenCache(PropKit.get(“onlineTokenUrl”));
            ApiConfigKit.setAccessTokenCache(localTestTokenCache);
        }
    }</p>

<div class="highlighter-rouge"><pre class="highlight"><code>public static void main(String[] args) throws Exception {
    init();
    System.out.println(AccessTokenApi.getAccessToken().getJson());
} }
</code></pre>
</div>

<p>```</p>

<h2 id="section-3">参考</h2>

<p><a href="http://www.jfinal.com/doc">jfinal 官方文档</a></p>

<p><a href="https://gitee.com/jfinal/jfinal-weixin/wikis/Home">jfinal-weixin wiki</a></p>
</div>
	</div>
<footer class="footer">
    <span>Copyright © 2016 皖ICP备16016174号</span>
    <a href="/sitemap.xml">网站地图</a>
    <span>Powered by</span>
    <a href="https://github.com/TMaize/tmaize-blog">tmaize-blog</a>
    <div class="up"></div>
</footer>
<script>
    //mta.qq.com 访问统计
    var _mtac = {};
    (function() {
        var mta = document.createElement("script");
        mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.2";
        mta.setAttribute("name", "MTAH5");
        mta.setAttribute("sid", "500581966");
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(mta, s);
    })();
    //360的自动推送
    (function(){
        var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?0b7f3f19682121293c3e4b62c9740281":"https://jspassport.ssl.qhimg.com/11.0.1.js?0b7f3f19682121293c3e4b62c9740281";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
    })();
    //百度的自动推送
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
</body>
</html>
