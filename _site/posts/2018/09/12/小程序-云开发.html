<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<meta http-equiv="content-language" content="zh-CN" />
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
		<meta name="keywords" content="TMaize,Nodejs"/>
		<meta name="author" content="TMaize" />
		<meta name="description" content="小程序-云开发"/>
		<link rel="icon" href="/static/img/favicon.ico" type="image/x-icon" />
		<link rel="shortcut icon" href="/static/img/favicon.ico" type="image/x-icon"/>
		<link rel="stylesheet" href="/static/css/blog.css">
		<link rel="stylesheet" href="/static/css/blog-post.css">
		<script>window.blog={contextPath:""}</script>
		<script type="text/javascript" src="/static/js/blog.js"></script>
		<title>小程序-云开发-TMaize Blog</title>
	</head>
<body>
<header class="header select-none">
    <a class="logo" title="TMaize Blog" href="/">
        <img src="/static/img/logo.jpg">
    </a>
    <a class="title" href="/">TMaize Blog</a>
    <nav class="menu">
        <a href="/">Blog</a>
        <a href="/pages/categories.html">Categories</a>
        <a href="/pages/search.html">Search</a>
        <a href="/pages/links.html">Links</a>
        <a href="/pages/chat.html">Chat</a>
        <a href="/pages/about.html">About</a>
    </nav>
    <span class="icon"></span>
</header>
	<div class="main animation-fadeUp post">
		
		<h1 class="title">小程序-云开发</h1>
		
		<div class="content"><p>最新更新的微信 web 开发者工具支持了云开发</p>

<p>和之前免费提供的自动部署的测试环境不同，这次是生产和开发都不需要一台独立的服务器了</p>

<p>取而代之的是云文件，云函数和云数据库（和 Bmob 云有点像）</p>

<p>更新到最新的微信 web 开发者工具就行了，需要了解更多请到<a href="https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html">官方 API</a>查看</p>

<h2 id="section">开通</h2>

<p>新建项目，使用云开发快速启动项目模板（必须是自己的 APPID，测试 APPID 没有这个模板）</p>

<p><img src="01.png" alt="01" /></p>

<p><img src="02.png" alt="02" /></p>

<p><img src="03.png" alt="03" /></p>

<h2 id="section-1">云文件</h2>

<p>其实就是一个在小程序中使用比较方便的对象存储</p>

<p>API</p>

<p><code class="highlighter-rouge">
wx.cloud.uploadFile // 如果上传至同一路径则是覆盖写
wx.cloud.downloadFile
wx.cloud.deleteFile
wx.cloud.deleteFile
</code></p>

<p>图片上传 Demo</p>

<p><code class="highlighter-rouge">
wx.chooseImage({
    success: function(res) {
        // 获取文件路径
        const filePath = res.tempFilePaths[0]
        // 定义上传位置，不要以/开头
        const cloudPath = 'upload/test.png'
        wx.cloud.uploadFile({
            filePath: filePath,
            cloudPath: cloudPath,
            success: res =&gt; {
                console.log('[上传文件] 成功：', res)
            },
            fail: e =&gt; {
                console.error('[上传文件] 失败：', e)
            },
            complete: () =&gt; {
                console.log('结束调用')
            }
        })
    }
})
</code></p>

<h2 id="section-2">云函数</h2>

<p>云函数在本地编写，上传到云端的 Node.js 运行环境中执行，然后返回结果。可以通过云函数后端 SDK 搭配使用多种服务，比如数据库和存储 API(wx-server-sdk)。</p>

<p>定义云函数存放目录</p>

<p><img src="04.png" alt="04" /></p>

<p>云函数根目录下的第一级目录（云函数目录）是与云函数名字相同的，如果函数已经上传到云端运行环境，则会有一个特殊的云图标</p>

<p><img src="05.png" alt="05" /></p>

<p>云函数代码</p>

<p><img src="06.png" alt="06" /></p>

<p>调用代码</p>

<p><code class="highlighter-rouge">
wx.cloud.callFunction({
    name: 'sum',
    data: {
        a: 1,
        b: 2
    },
    success: res =&gt; {
        console.error('[云函数] [sum] 调用成功：', res)
        console.log(JSON.stringify(res.result))
    },
    fail: err =&gt; {
        console.error('[云函数] [sum] 调用失败：', err)
    }
})
</code></p>

<p>输出结果存放在 res.result 中，为了看出 event 和 context 的作用，在返回结果中顺便返回了这两个内容,打印了出来</p>

<p>可以看到，event 就是传入的参数，同时会自动添加 userInfo 信息。context 是云函数的运行环境参数</p>

<p><code class="highlighter-rouge"><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="err">event:</span><span class="w"> </span><span class="err">{</span><span class="w">
        </span><span class="err">a:</span><span class="w"> </span><span class="err">1,</span><span class="w">
        </span><span class="err">b:</span><span class="w"> </span><span class="err">2,</span><span class="w">
        </span><span class="err">userInfo:</span><span class="w"> </span><span class="err">{</span><span class="w">
            </span><span class="err">appId:</span><span class="w"> </span><span class="err">'xxxxx',</span><span class="w">
            </span><span class="err">openId:</span><span class="w"> </span><span class="err">'xxxxxx'</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="err">},</span><span class="w">
    </span><span class="err">context:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="err">callbackWaitsForEmptyEventLoop:</span><span class="w"> </span><span class="err">false,</span><span class="w">
        </span><span class="err">memory_limit_in_mb:</span><span class="w"> </span><span class="err">256,</span><span class="w">
        </span><span class="err">time_limit_in_ms:</span><span class="w"> </span><span class="err">20000,</span><span class="w">
        </span><span class="err">request_id:</span><span class="w"> </span><span class="err">'422e93b4-b5db-11e8-b8a8-525400e8849e',</span><span class="w">
        </span><span class="err">environ:</span><span class="w"> </span><span class="err">'xxxx'</span><span class="w">
    </span><span class="p">}</span><span class="err">,</span><span class="w">
    </span><span class="err">sum:</span><span class="w"> </span><span class="mi">3</span><span class="w">
</span><span class="err">}</span><span class="w">
</span></code></p>

<p>既然是 Node.js 的话，一些 Node.js 的库也是可以用的，比如要发送请求的时候可以通过云函数做代理来发送请求，从而就突破了小程序的合法域名的限制</p>

<p>```
var http = require(‘http’)</p>

<p>exports.main = (event, context) =&gt; {
    return new Promise((resolve, reject) =&gt; {
        let respData = 1
        const req = http.request(event.options, res =&gt; {
            res.on(‘data’, chunk =&gt; {
                respData += chunk
            })
            res.on(‘end’, () =&gt; {
                resolve(respData)
            })
            if (res.statusCode != 200) {
                req.abort()
                reject(‘res.statusCode != 200’)
            }
        })
        req.on(‘error’, e =&gt; {
            reject(e.message)
        })</p>

<div class="highlighter-rouge"><pre class="highlight"><code>    req.end()
}) } ```
</code></pre>
</div>

<h2 id="section-3">云数据库</h2>

<p>官方介绍说是云开发提供了一个 JSON 数据库，使用起来也很简单，同时也提供了简单的图形化操作界面</p>

<p>注意在云函数和小程序里都可以使用云数据库</p>

<p>先创建一个集合，也就是数据库的 table 吧</p>

<p><img src="07.png" alt="07" /></p>

<p>但是并不要求是每一行的数据结构都一样，当然了，为了操作方便，每行的数据格式都应该是一致的</p>

<p><img src="07.png" alt="07" /></p>

<h3 id="section-4">查询</h3>

<p>简单的根据主键查询</p>

<p><code class="highlighter-rouge">
// 获得数据库引用
const db = wx.cloud.database()
// 构造查询条件,指定集合
const users = db.collection('users')
// 构造查询条件,指定_id
const u = users.doc('1')
// 开始查询
u.get({
    success: function(res) {
        console.log(res.data)
    }
})
</code></p>

<p>条件查询</p>

<p>除了主键查询，还提供了一系列的指令，通过 db.command 获得</p>

<p>查询指令有：eq,neq,lt,lte,gt,gte,in,nin</p>

<p><code class="highlighter-rouge">
const db = wx.cloud.database()
const _ = db.command
const users = db.collection('users')
users.where({
    name: _.in(['张三', '李四'])
}).get({
    success: function(res) {
        console.log(res.data)
    },
    fail(e) {
        console.log(e)
    }
})
</code></p>

<p>逻辑指令有：and,or。上面的查询使用逻辑指令可以写成</p>

<p><code class="highlighter-rouge">
name: _.eq('张三').or(_.eq('李四'))
</code></p>

<h3 id="section-5">修改</h3>

<p>前提是要有权限，不然会 errCode: -502003 database permission denied</p>

<p>局部更新，update 方法，只对某个记录的某些字段更新</p>

<p>更新指令：set,remove,inc,mul,push,pop,shift,unshift</p>

<p><code class="highlighter-rouge">
const db = wx.cloud.database()
const _ = db.command
const users = db.collection('users')
users.doc('1').update({
    data: {
        name:'xxx'
    },
    success: function() {
        console.log('success')
    },
    fail(e){
        console.log(e)
    }
})
</code></p>

<p>替换更新，set 方法，替换更新一条记录</p>

<p>删除记录，remove 方法</p>
</div>
	</div>
<footer class="footer">
    <span>Copyright © 2016 皖ICP备16016174号</span>
    <a href="/sitemap.xml">网站地图</a>
    <span>Powered by</span>
    <a href="https://github.com/TMaize/tmaize-blog">tmaize-blog</a>
    <div class="up"></div>
</footer>
<script>
    //mta.qq.com 访问统计
    var _mtac = {};
    (function() {
        var mta = document.createElement("script");
        mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.2";
        mta.setAttribute("name", "MTAH5");
        mta.setAttribute("sid", "500581966");
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(mta, s);
    })();
    //360的自动推送
    (function(){
        var src = (document.location.protocol == "http:") ? "http://js.passport.qihucdn.com/11.0.1.js?0b7f3f19682121293c3e4b62c9740281":"https://jspassport.ssl.qhimg.com/11.0.1.js?0b7f3f19682121293c3e4b62c9740281";
        document.write('<script src="' + src + '" id="sozz"><\/script>');
    })();
    //百度的自动推送
    (function(){
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        }
        else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>
</body>
</html>
